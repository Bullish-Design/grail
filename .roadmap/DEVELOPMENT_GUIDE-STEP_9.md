# Grail v2 Development Guide 

This guide provides detailed, step-by-step instructions for implementing Grail v2 from scratch. Each step includes concrete implementation details, algorithms, and comprehensive testing requirements.

---

## Development Principles

1. **Build incrementally** - Each step should be fully tested before moving to the next
2. **Test everything** - Unit tests before integration tests, validate before building
3. **Keep it simple** - No premature optimization, no unnecessary abstractions
4. **Make errors visible** - All errors map back to `.pym` file line numbers

---

## Step 9: Artifacts Manager

**Purpose**: Manage the `.grail/` directory and all generated artifacts.

### Work to be done

Create `src/grail/artifacts.py`:

```python
"""Artifacts manager for .grail/ directory."""
import json
from pathlib import Path
from typing import Any

from grail._types import CheckResult, ExternalSpec, InputSpec


class ArtifactsManager:
    """Manages .grail/ directory and generated artifacts."""

    def __init__(self, grail_dir: Path):
        """
        Initialize artifacts manager.

        Args:
            grail_dir: Path to .grail/ directory
        """
        self.grail_dir = grail_dir

    def get_script_dir(self, script_name: str) -> Path:
        """Get directory for a specific script's artifacts."""
        return self.grail_dir / script_name

    def write_script_artifacts(
        self,
        script_name: str,
        stubs: str,
        monty_code: str,
        check_result: CheckResult,
        externals: dict[str, ExternalSpec],
        inputs: dict[str, InputSpec]
    ) -> None:
        """
        Write all artifacts for a script.

        Args:
            script_name: Name of the script
            stubs: Generated type stubs
            monty_code: Generated Monty code
            check_result: Validation results
            externals: External function specs
            inputs: Input specs
        """
        script_dir = self.get_script_dir(script_name)
        script_dir.mkdir(parents=True, exist_ok=True)

        # Write stubs.pyi
        (script_dir / "stubs.pyi").write_text(stubs)

        # Write monty_code.py
        (script_dir / "monty_code.py").write_text(
            "# Auto-generated by grail â€” this is what Monty actually executes\n\n"
            + monty_code
        )

        # Write check.json
        check_data = {
            "file": check_result.file,
            "valid": check_result.valid,
            "errors": [
                {
                    "line": e.lineno,
                    "column": e.col_offset,
                    "code": e.code,
                    "message": e.message,
                    "suggestion": e.suggestion
                }
                for e in check_result.errors
            ],
            "warnings": [
                {
                    "line": w.lineno,
                    "column": w.col_offset,
                    "code": w.code,
                    "message": w.message
                }
                for w in check_result.warnings
            ],
            "info": check_result.info
        }
        (script_dir / "check.json").write_text(
            json.dumps(check_data, indent=2)
        )

        # Write externals.json
        externals_data = {
            "externals": [
                {
                    "name": ext.name,
                    "async": ext.is_async,
                    "parameters": [
                        {
                            "name": p.name,
                            "type": p.type_annotation,
                            "default": p.default
                        }
                        for p in ext.parameters
                    ],
                    "return_type": ext.return_type,
                    "docstring": ext.docstring
                }
                for ext in externals.values()
            ]
        }
        (script_dir / "externals.json").write_text(
            json.dumps(externals_data, indent=2)
        )

        # Write inputs.json
        inputs_data = {
            "inputs": [
                {
                    "name": inp.name,
                    "type": inp.type_annotation,
                    "required": inp.required,
                    "default": inp.default
                }
                for inp in inputs.values()
            ]
        }
        (script_dir / "inputs.json").write_text(
            json.dumps(inputs_data, indent=2)
        )

    def write_run_log(
        self,
        script_name: str,
        stdout: str,
        stderr: str,
        duration_ms: float,
        success: bool
    ) -> None:
        """
        Write execution log.

        Args:
            script_name: Name of the script
            stdout: Standard output
            stderr: Standard error
            duration_ms: Execution duration in milliseconds
            success: Whether execution succeeded
        """
        script_dir = self.get_script_dir(script_name)
        script_dir.mkdir(parents=True, exist_ok=True)

        log_lines = []
        log_lines.append(f"[grail] Execution {'succeeded' if success else 'failed'}")
        log_lines.append(f"[grail] Duration: {duration_ms:.2f}ms")
        log_lines.append("")

        if stdout:
            log_lines.append("[stdout]")
            log_lines.append(stdout)
            log_lines.append("")

        if stderr:
            log_lines.append("[stderr]")
            log_lines.append(stderr)

        (script_dir / "run.log").write_text("\n".join(log_lines))

    def clean(self) -> None:
        """Remove the entire .grail/ directory."""
        import shutil
        if self.grail_dir.exists():
            shutil.rmtree(self.grail_dir)
```

### Testing/Validation

Create `tests/unit/test_artifacts.py`:

```python
"""Test artifacts manager."""
import json
from pathlib import Path

from grail.artifacts import ArtifactsManager
from grail._types import CheckResult, ExternalSpec, InputSpec, ParamSpec


def test_creates_directory_structure(tmp_path):
    """Should create .grail/<script>/ directory structure."""
    mgr = ArtifactsManager(tmp_path / ".grail")

    externals = {
        "test_func": ExternalSpec(
            name="test_func",
            is_async=True,
            parameters=[ParamSpec("x", "int", None)],
            return_type="str",
            docstring="Test",
            lineno=1,
            col_offset=0
        )
    }
    inputs = {
        "test_input": InputSpec(
            name="test_input",
            type_annotation="int",
            default=None,
            required=True,
            lineno=1,
            col_offset=0
        )
    }
    check_result = CheckResult(
        file="test.pym",
        valid=True,
        errors=[],
        warnings=[],
        info={}
    )

    mgr.write_script_artifacts(
        "test",
        "# stubs",
        "# code",
        check_result,
        externals,
        inputs
    )

    script_dir = tmp_path / ".grail" / "test"
    assert script_dir.exists()
    assert (script_dir / "stubs.pyi").exists()
    assert (script_dir / "monty_code.py").exists()
    assert (script_dir / "check.json").exists()
    assert (script_dir / "externals.json").exists()
    assert (script_dir / "inputs.json").exists()


def test_write_run_log(tmp_path):
    """Should write run.log with execution details."""
    mgr = ArtifactsManager(tmp_path / ".grail")

    mgr.write_run_log(
        "test",
        stdout="Hello world",
        stderr="",
        duration_ms=42.5,
        success=True
    )

    log_path = tmp_path / ".grail" / "test" / "run.log"
    assert log_path.exists()

    content = log_path.read_text()
    assert "succeeded" in content
    assert "42.50ms" in content
    assert "Hello world" in content


def test_clean_removes_directory(tmp_path):
    """Should remove entire .grail/ directory."""
    grail_dir = tmp_path / ".grail"
    grail_dir.mkdir()
    (grail_dir / "test.txt").write_text("test")

    mgr = ArtifactsManager(grail_dir)
    mgr.clean()

    assert not grail_dir.exists()


def test_json_artifacts_are_valid(tmp_path):
    """Generated JSON files should be valid JSON."""
    mgr = ArtifactsManager(tmp_path / ".grail")

    externals = {
        "func": ExternalSpec(
            "func", True, [ParamSpec("x", "int", 10)],
            "str", "Doc", 1, 0
        )
    }
    inputs = {"x": InputSpec("x", "int", None, True, 1, 0)}
    check_result = CheckResult("test.pym", True, [], [], {})

    mgr.write_script_artifacts("test", "stubs", "code", check_result, externals, inputs)

    # Should be able to parse JSON
    script_dir = tmp_path / ".grail" / "test"
    check_data = json.loads((script_dir / "check.json").read_text())
    externals_data = json.loads((script_dir / "externals.json").read_text())
    inputs_data = json.loads((script_dir / "inputs.json").read_text())

    assert check_data["valid"] is True
    assert len(externals_data["externals"]) == 1
    assert len(inputs_data["inputs"]) == 1
```

**Validation checklist**:
- [ ] `pytest tests/unit/test_artifacts.py` passes
- [ ] All artifact files are created
- [ ] JSON files are valid
- [ ] Clean removes directory
