# Grail v2 Development Guide 

This guide provides detailed, step-by-step instructions for implementing Grail v2 from scratch. Each step includes concrete implementation details, algorithms, and comprehensive testing requirements.

---

## Development Principles

1. **Build incrementally** - Each step should be fully tested before moving to the next
2. **Test everything** - Unit tests before integration tests, validate before building
3. **Keep it simple** - No premature optimization, no unnecessary abstractions
4. **Make errors visible** - All errors map back to `.pym` file line numbers

---

## Step 7: Stubs Generator

**Purpose**: Generate `.pyi` type stub files from `@external` and `Input()` declarations.

### Work to be done

Create `src/grail/stubs.py`:

```python
"""Type stub generator for Monty's type checker."""
from grail._types import ExternalSpec, InputSpec


def generate_stubs(
    externals: dict[str, ExternalSpec],
    inputs: dict[str, InputSpec]
) -> str:
    """
    Generate .pyi stub file content from declarations.

    Args:
        externals: External function specifications
        inputs: Input variable specifications

    Returns:
        .pyi file content as string
    """
    lines = [
        "# Auto-generated by grail â€” do not edit",
        ""
    ]

    # Check if we need Any import
    needs_any = False

    for ext in externals.values():
        if "Any" in ext.return_type:
            needs_any = True
        for param in ext.parameters:
            if "Any" in param.type_annotation:
                needs_any = True

    for inp in inputs.values():
        if "Any" in inp.type_annotation:
            needs_any = True

    # Add imports
    if needs_any:
        lines.append("from typing import Any")
        lines.append("")

    # Add input variable declarations
    if inputs:
        for inp in inputs.values():
            lines.append(f"{inp.name}: {inp.type_annotation}")
        lines.append("")

    # Add external function signatures
    for ext in externals.values():
        # Build parameter list
        params = []
        for param in ext.parameters:
            if param.default is not None:
                # Has default value
                if isinstance(param.default, str):
                    # String default (for non-literals)
                    params.append(f"{param.name}: {param.type_annotation} = {param.default}")
                else:
                    params.append(f"{param.name}: {param.type_annotation} = {repr(param.default)}")
            else:
                params.append(f"{param.name}: {param.type_annotation}")

        params_str = ", ".join(params)

        # Add function signature
        if ext.is_async:
            lines.append(f"async def {ext.name}({params_str}) -> {ext.return_type}:")
        else:
            lines.append(f"def {ext.name}({params_str}) -> {ext.return_type}:")

        # Add docstring if present
        if ext.docstring:
            lines.append(f'    """{ext.docstring}"""')

        # Add ellipsis body
        lines.append("    ...")
        lines.append("")

    return "\n".join(lines)
```

### Testing/Validation

Create `tests/unit/test_stubs.py`:

```python
"""Test type stub generation."""
from grail._types import ExternalSpec, InputSpec, ParamSpec
from grail.stubs import generate_stubs


def test_generate_simple_stub():
    """Generate stub for simple external function."""
    externals = {
        "double": ExternalSpec(
            name="double",
            is_async=True,
            parameters=[ParamSpec("n", "int", None)],
            return_type="int",
            docstring="Double a number.",
            lineno=1,
            col_offset=0
        )
    }
    inputs = {
        "x": InputSpec(
            name="x",
            type_annotation="int",
            default=None,
            required=True,
            lineno=1,
            col_offset=0
        )
    }

    stub = generate_stubs(externals, inputs)

    assert "x: int" in stub
    assert "async def double(n: int) -> int:" in stub
    assert "Double a number." in stub
    assert "..." in stub


def test_stub_with_any_import():
    """Stub should import Any when needed."""
    externals = {
        "fetch": ExternalSpec(
            name="fetch",
            is_async=True,
            parameters=[ParamSpec("url", "str", None)],
            return_type="dict[str, Any]",
            docstring=None,
            lineno=1,
            col_offset=0
        )
    }

    stub = generate_stubs(externals, {})

    assert "from typing import Any" in stub
    assert "dict[str, Any]" in stub


def test_stub_with_defaults():
    """Stub should include default parameter values."""
    externals = {
        "process": ExternalSpec(
            name="process",
            is_async=False,
            parameters=[
                ParamSpec("x", "int", None),
                ParamSpec("y", "int", 10),
            ],
            return_type="int",
            docstring=None,
            lineno=1,
            col_offset=0
        )
    }

    stub = generate_stubs(externals, {})

    assert "def process(x: int, y: int = 10) -> int:" in stub


def test_multiple_inputs_and_externals():
    """Stub should handle multiple declarations."""
    externals = {
        "func1": ExternalSpec("func1", True, [], "None", None, 1, 0),
        "func2": ExternalSpec("func2", False, [], "str", None, 2, 0),
    }
    inputs = {
        "a": InputSpec("a", "int", None, True, 1, 0),
        "b": InputSpec("b", "str", "default", False, 2, 0),
    }

    stub = generate_stubs(externals, inputs)

    assert "a: int" in stub
    assert "b: str" in stub
    assert "async def func1() -> None:" in stub
    assert "def func2() -> str:" in stub
```

**Validation checklist**:
- [ ] `pytest tests/unit/test_stubs.py` passes
- [ ] Generated stubs are valid Python
- [ ] Imports are added when needed
- [ ] Docstrings are preserved
